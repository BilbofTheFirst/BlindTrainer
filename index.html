<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>BlindTrainer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" href="icon-192.png" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <meta name="theme-color" content="#111827">

   <style>
    /* Tout en box-sizing: border-box pour √©viter les d√©bordements */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        max-width: 100%;
        overflow-x: hidden;              /* PLUS AUCUN SCROLL HORIZONTAL */
        background: #111827;
        color: #e5e7eb;
        font-family: system-ui, sans-serif;
    }

    body {
        display: flex;
        flex-direction: column;
    }

    .app {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 10px 12px 70px;         /* espace r√©serv√© pour le bouton bas */
        box-sizing: border-box;
    }

    h1 {
        margin: 0 0 10px;
        text-align: center;
        font-size: 1.4rem;
    }

    /* --- PANELS G√âN√âRAUX --- */

    .card,
    .blind-card {
        background: #1f2937;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        max-width: 100%;                 /* ne d√©passe jamais l‚Äô√©cran */
    }

    /* --- PANEL PLAYLIST --- */

    .playlist-row {
        display: grid;                   /* 2 colonnes : select + bouton */
        grid-template-columns: minmax(0, 1fr) auto;
        column-gap: 8px;
        align-items: center;
        width: 100%;
    }

    /* Le select prend toute la 1√®re colonne et se compresse si besoin */
    .playlist-row select {
        width: 100%;
        min-width: 0;                    /* IMPORTANT pour permettre la compression */
        padding: 10px;
        border-radius: 999px;
        border: 1px solid #374151;
        font-size: 1rem;
        background: #111827;
        color: #e5e7eb;
        white-space: nowrap;             /* une seule ligne */
        overflow: hidden;
        text-overflow: ellipsis;         /* ... si trop long */
    }

    /* Bouton de chargement ‚Äì petit carr√© fixe √† droite */
    .btn-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #3b82f6;
        color: white;
        border: none;
    }

    /* --- PANEL BLIND TEST --- */

    .blind-card {
        border-radius: 14px;
        padding: 16px;
        flex: 1 1 auto;
        min-height: 45vh;
        display: flex;
        flex-direction: column;
    }

    .top-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .play-toggle {
        font-size: 1.6rem;
        background: none;
        border: none;
        color: #e5e7eb;
        padding: 6px;
    }

    .track-panel {
        flex: 1;
        display: flex;
        justify-content: center;
        flex-direction: column;
        text-align: center;
    }

    .hidden-title {
        font-size: 2rem;
        color: #6b7280;
        margin-top: 8px;
    }

    .track-title {
        font-size: 2rem;
        font-weight: 600;
    }

    .track-artist {
        font-size: 2rem;
        font-weight: 600;
    }

    /* --- BUTTONS --- */

    .buttons-main {
        display: flex;
        flex-direction: column;
        gap: 14px;
        margin-top: 10px;
    }

    .btn-big {
        padding: 18px;
        border-radius: 14px;
        font-size: 1.4rem;
        width: 100%;
        border: none;
    }

    .btn-primary { background: #3b82f6; color: white; }
    .btn-ok      { background: #22c55e; color: #022c22; }
    .btn-ko      { background: #f97316; color: #111; }

    /* --- FOOTER RESET BUTTON --- */

    .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #111827;
        padding: 10px;
        display: flex;
        justify-content: center;
        z-index: 999;
    }

    .footer button {
        padding: 10px 20px;
        font-size: 1rem;
        border-radius: 12px;
        border: none;
        background: #374151;
        color: #e5e7eb;
    }
</style>

</head>
<body>

<div class="app">
    <h1>BlindTrainer</h1>

    <!-- PANEL PLAYLIST -->
    <div class="card">
        <div id="spotify-status" style="margin-bottom:8px;font-size:0.9rem;"></div>

        <div class="playlist-row" id="spotify-actions">
            <!-- select + bouton charger -->
        </div>
    </div>

    <!-- PANEL BLIND TEST -->
    <div class="blind-card">
        <div class="top-line">
            <div id="progress"></div>
            <!-- BOUTON PLAY/PAUSE -->
            <button id="btn-play-toggle" class="play-toggle">‚è∏</button>
        </div>

        <div id="track-area" class="track-panel"></div>

        <div class="buttons-main">
            <button id="show-answer" class="btn-big btn-primary">Afficher la r√©ponse</button>
            <button id="btn-ok" class="btn-big btn-ok" style="display:none;">OK</button>
            <button id="btn-ko" class="btn-big btn-ko" style="display:none;">KO</button>
        </div>
    </div>

    <!-- FOOTER RESET -->
    <div class="footer">
        <button id="btn-reset">R√©initialiser</button>
    </div>
</div>

<!-- SDK SPOTIFY -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
/* ------------------------------
   CONFIG SPOTIFY
--------------------------------*/
const clientId = "f2f3de9d08c74a71a97d8250b1864204";
const redirectUri = "https://bilbofthefirst.github.io/BlindTrainer/";

const spotifyScopes = [
    "streaming",
    "user-read-email",
    "user-read-private",
    "user-modify-playback-state",
    "user-read-playback-state",
    "playlist-read-private",
    "playlist-read-collaborative"
].join(" ");

/* ------------------------------
   STATE
--------------------------------*/
let allTracks = [];
let remainingTracks = [];
let currentTrack = null;
let currentPlaylistName = "Aucune playlist charg√©e";
let showAnswer = false;

let accessToken = null;
let spotifyUser = null;
let spotifyPlaylists = [];

let spotifyPlayer = null;
let spotifyDeviceId = null;
let isPlaying = false;

/* ------------------------------
   DOM ELEMENTS
--------------------------------*/
const trackArea   = document.getElementById("track-area");
const progressEl  = document.getElementById("progress");
const btnShow     = document.getElementById("show-answer");
const btnOK       = document.getElementById("btn-ok");
const btnKO       = document.getElementById("btn-ko");
const btnPlayTgl  = document.getElementById("btn-play-toggle");
const btnReset    = document.getElementById("btn-reset");

/* ------------------------------
   UTILS
--------------------------------*/
function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    return Array.from(crypto.getRandomValues(new Uint8Array(length)))
        .map(x => chars[x % chars.length]).join("");
}

async function sha256(str) {
    return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
}

function base64encode(buf) {
    return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
}

function saveToken(token, expiresIn) {
    accessToken = token;
    localStorage.setItem("spotify_access_token", token);
    localStorage.setItem("spotify_exp", Date.now() + expiresIn * 1000);
}

function loadToken() {
    const t = localStorage.getItem("spotify_access_token");
    const exp = localStorage.getItem("spotify_exp");
    if (!t || !exp || Date.now() > exp) return null;
    accessToken = t;
    return t;
}

/* ------------------------------
   RENDER
--------------------------------*/
function updatePlayButton() {
    if (!allTracks.length) {
        btnPlayTgl.style.visibility = "hidden";
        return;
    }
    btnPlayTgl.style.visibility = "visible";
    btnPlayTgl.textContent = isPlaying ? "‚è∏" : "‚ñ∂Ô∏è";
}

function render() {
    progressEl.textContent = `Restants : ${remainingTracks.length} / ${allTracks.length}`;
    updatePlayButton();

    if (!allTracks.length) {
        trackArea.innerHTML = `
            <div style="font-size:1.2rem;font-weight:600;">Aucune playlist charg√©e</div>
            <div style="margin-top:4px;color:#9ca3af;">S√©lectionne une playlist en haut.</div>
        `;
        btnShow.style.display = "none";
        btnOK.style.display   = "none";
        btnKO.style.display   = "none";
        return;
    }

    if (!currentTrack) return;

    if (!showAnswer) {
        btnShow.style.display = "block";
        btnOK.style.display   = "none";
        btnKO.style.display   = "none";

        trackArea.innerHTML = `
            <div style="font-size:1rem;color:#9ca3af;">√âcoute la musique‚Ä¶</div>
            <div class="hidden-title">Titre cach√©</div>
        `;
    } else {
        btnShow.style.display = "none";
        btnOK.style.display   = "block";
        btnKO.style.display   = "block";

        trackArea.innerHTML = `
			<div class="track-title">${currentTrack.title}</div>
            <div class="track-artist">${currentTrack.artist}</div>
        `;
    }
}

/* ------------------------------
   BLIND TEST LOGIC
--------------------------------*/
function initGame(tracks, name) {
    allTracks = tracks || [];
    currentPlaylistName = name || "Playlist Spotify";
    remainingTracks = [...allTracks];
    showAnswer = false;
    isPlaying = false;
    if (remainingTracks.length > 0) {
        pickRandomTrack();
    } else {
        currentTrack = null;
        render();
    }
}

function pickRandomTrack() {
    if (!remainingTracks.length) {
        isPlaying = false;
        updatePlayButton();
        progressEl.textContent = `Restants : 0 / ${allTracks.length}`;
        trackArea.innerHTML = `
            <div class="emoji">üéâ</div>
            <div class="done-message">Tu connais toute la playlist !</div>
        `;
        btnShow.style.display = "none";
        btnOK.style.display   = "none";
        btnKO.style.display   = "none";
        return;
    }

    const idx = Math.floor(Math.random() * remainingTracks.length);
    currentTrack = remainingTracks[idx];
    showAnswer = false;
    playCurrentTrack();
    render();
}

/* ------------------------------
   SPOTIFY PLAYBACK
--------------------------------*/
async function makeThisDeviceActive() {
    if (!spotifyDeviceId || !accessToken) return;
    try {
        await fetch("https://api.spotify.com/v1/me/player", {
            method: "PUT",
            headers: {
                "Authorization": "Bearer " + accessToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ device_ids: [spotifyDeviceId], play: false })
        });
    } catch (e) {
        console.error("Erreur activation device:", e);
    }
}

async function playCurrentTrack() {
    if (!spotifyDeviceId || !currentTrack || !accessToken) return;

    try {
        await makeThisDeviceActive();

        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
            method: "PUT",
            headers: {
                "Authorization": "Bearer " + accessToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ uris: [currentTrack.uri] })
        });

        isPlaying = true;
        updatePlayButton();
    } catch (e) {
        console.error("Erreur lecture:", e);
    }
}

async function togglePlayPause() {
    if (!spotifyDeviceId || !accessToken || !allTracks.length) return;

    try {
        if (isPlaying) {
            await fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${spotifyDeviceId}`, {
                method: "PUT",
                headers: { "Authorization": "Bearer " + accessToken }
            });
            isPlaying = false;
        } else {
            await makeThisDeviceActive();
            await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
                method: "PUT",
                headers: { "Authorization": "Bearer " + accessToken }
            });
            isPlaying = true;
        }
        updatePlayButton();
    } catch (e) {
        console.error("Erreur play/pause:", e);
    }
}

/* ------------------------------
   SPOTIFY AUTH
--------------------------------*/
async function loginSpotify() {
    const verifier  = generateRandomString(64);
    const challenge = base64encode(await sha256(verifier));
    localStorage.setItem("spotify_verifier", verifier);

    const params = new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        redirect_uri: redirectUri,
        code_challenge_method: "S256",
        code_challenge: challenge,
        scope: spotifyScopes
    });

    window.location.href =
        "https://accounts.spotify.com/authorize?" + params.toString();
}

async function exchangeToken(code) {
    const verifier = localStorage.getItem("spotify_verifier");
    if (!verifier) return;

    const body = new URLSearchParams({
        client_id: clientId,
        grant_type: "authorization_code",
        code,
        redirect_uri: redirectUri,
        code_verifier: verifier
    });

    const resp = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
    });

    const data = await resp.json();
    if (data.access_token) {
        saveToken(data.access_token, data.expires_in);
    } else {
        console.error("Erreur token:", data);
    }
}

/* ------------------------------
   CHARGEMENT PLAYLISTS / TRACKS
--------------------------------*/
async function loadPlaylists() {
    const res = [];
    let url = "https://api.spotify.com/v1/me/playlists?limit=50";

    while (url) {
        const r = await fetch(url, { headers: { "Authorization": "Bearer " + accessToken } });
        const j = await r.json();
        res.push(...(j.items || []));
        url = j.next;
    }
    return res;
}

async function loadTracks(playlistId, playlistLabel) {
    let items = [];
    let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;

    while (url) {
        const r = await fetch(url, { headers: { "Authorization": "Bearer " + accessToken } });
        const j = await r.json();
        items.push(...(j.items || []));
        url = j.next;
    }

    const tracks = items
        .map(x => x.track)
        .filter(x => x && x.id && x.artists?.length)
        .map(x => ({
            id: x.id,
            uri: x.uri,
            title: x.name,
            artist: x.artists[0].name
        }));

    initGame(tracks, playlistLabel);
    render();
}

/* ------------------------------
   WEB PLAYBACK SDK
--------------------------------*/
function initPlayer() {
    if (!window.Spotify || spotifyPlayer) return;

    spotifyPlayer = new Spotify.Player({
        name: "BlindTrainer Player",
        getOAuthToken: cb => cb(accessToken),
        volume: 0.5
    });

    spotifyPlayer.addListener("ready", ({ device_id }) => {
        spotifyDeviceId = device_id;
        renderSpotifyArea();
    });

    spotifyPlayer.addListener("initialization_error", e => console.error(e));
    spotifyPlayer.addListener("authentication_error", e => console.error(e));
    spotifyPlayer.addListener("account_error", e => console.error(e));
    spotifyPlayer.addListener("playback_error", e => console.error(e));

    spotifyPlayer.connect();
}

window.onSpotifyWebPlaybackSDKReady = () => {
    if (accessToken) initPlayer();
};

/* ------------------------------
   UI SPOTIFY PANEL
--------------------------------*/
function renderSpotifyArea() {
    const status  = document.getElementById("spotify-status");
    const actions = document.getElementById("spotify-actions");
    actions.innerHTML = "";

    if (!accessToken) {
        status.textContent = "Non connect√© √† Spotify";
        const b = document.createElement("button");
        b.textContent = "Connexion Spotify";
        b.className = "btn-big btn-primary";
        b.style.fontSize = "1rem";
        b.onclick = loginSpotify;
        actions.appendChild(b);
        return;
    }

    const userName = spotifyUser?.display_name || "Utilisateur Spotify";
    status.textContent =
        spotifyDeviceId
            ? `Connect√© en tant que ${userName} ‚Ä¢ Player pr√™t`
            : `Connect√© en tant que ${userName} ‚Ä¢ Initialisation du player‚Ä¶`;

    if (!spotifyPlaylists || !spotifyPlaylists.length) {
        actions.textContent = "Chargement des playlists‚Ä¶";
        return;
    }

    const row = document.createElement("div");
    row.className = "playlist-row";

    const select = document.createElement("select");
    spotifyPlaylists.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.name} (${p.tracks.total})`;
        select.appendChild(opt);
    });

    const btn = document.createElement("button");
    btn.className = "btn-icon";
    btn.textContent = "‚ñ∂";
    btn.title = "Charger la playlist";
    btn.onclick = () => {
        const opt = select.options[select.selectedIndex];
        loadTracks(opt.value, opt.text);
    };

    row.appendChild(select);
    row.appendChild(btn);
    actions.appendChild(row);
}

/* ------------------------------
   BOOTSTRAP
--------------------------------*/
(async function start() {
    loadToken();

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    if (!accessToken && code) {
        await exchangeToken(code);
        window.history.replaceState({}, document.title, redirectUri);
    }

    loadToken();

    if (accessToken) {
        const rMe = await fetch("https://api.spotify.com/v1/me", {
            headers: { "Authorization": "Bearer " + accessToken }
        });
        spotifyUser = await rMe.json();

        spotifyPlaylists = await loadPlaylists();
        initPlayer();
    }

    renderSpotifyArea();
    render();
})();

/* ------------------------------
   EVENTS
--------------------------------*/
btnShow.onclick = () => {
    showAnswer = true;
    render();
};

btnOK.onclick = () => {
    if (!currentTrack) return;
    remainingTracks = remainingTracks.filter(t => t.id !== currentTrack.id);
    pickRandomTrack();
};

btnKO.onclick = () => {
    if (!currentTrack) return;
    pickRandomTrack();
};

btnPlayTgl.onclick = togglePlayPause;

btnReset.onclick = () => {
    initGame(allTracks, currentPlaylistName);
    render();
};
</script>
</body>
</html>
