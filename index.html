<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Blind Test â€“ EntraÃ®nement</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #111827;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .app {
            width: 100%;
            max-width: 480px;
            padding: 24px 16px 40px;
            box-sizing: border-box;
        }
        h1 {
            font-size: 1.3rem;
            margin: 0 0 8px;
            text-align: center;
        }
        .subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 16px;
        }
        .card {
            background: #1f2937;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        .card-spotify {
            margin-bottom: 20px;
        }
        .spotify-status {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .spotify-actions select {
            background: #111827;
            color: #e5e7eb;
            border-radius: 999px;
            border: 1px solid #374151;
            padding: 6px 8px;
            margin-right: 6px;
            margin-top: 4px;
            max-width: 100%;
        }
        button {
            border: none;
            border-radius: 999px;
            padding: 10px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #374151; color: #e5e7eb; }
        .btn-ok { background: #22c55e; color: #022c22; }
        .btn-ko { background: #f97316; color: #111827; }
        .btn-small { padding: 6px 10px; font-size: 0.8rem; }

        .track-label { text-align:center; margin-bottom:12px; }
        .hidden-title { text-align:center; font-size:1.3rem; color:#6b7280; }
        .track-title { text-align:center; font-size:1.3rem; font-weight:700; }
        .track-artist { text-align:center; color:#9ca3af; }
        .buttons-main { display:flex; gap:10px; justify-content:center; margin-top:15px; flex-wrap:wrap; }
        .progress { margin-bottom:8px; }
        #btn-ok, #btn-ko { display:none; }
    </style>
</head>
<body>

<div class="app">
    <h1>Blind Test â€“ EntraÃ®nement</h1>
    <div class="subtitle">Connecte-toi Ã  Spotify, choisis une playlist, et laisse lâ€™app lancer les morceaux ðŸŽ§</div>

    <div class="card card-spotify">
        <div id="spotify-status" class="spotify-status"></div>
        <div id="spotify-actions" class="spotify-actions"></div>
    </div>

    <div class="card">
        <div id="playlist-name"></div>
        <div id="progress" class="progress"></div>
        <div id="track-area"></div>

        <div class="audio-hint" style="text-align:center; font-size:0.8rem; margin-top:6px;">
            La musique est lue depuis Spotify dans cette page.
        </div>

        <div class="buttons-main">
            <button id="show-answer" class="btn-primary">Afficher la rÃ©ponse</button>
            <button id="btn-ok" class="btn-ok">OK</button>
            <button id="btn-ko" class="btn-ko">KO</button>
        </div>
    </div>

    <div class="buttons-main">
        <button id="btn-reset" class="btn-secondary">RÃ©initialiser</button>
    </div>
</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>

<script>
/* ------------------------------
      CONFIG SPOTIFY
--------------------------------*/
const clientId = "f2f3de9d08c74a71a97d8250b1864204";
const redirectUri = "https://bilbofthefirst.github.io/BlindTrainer/";

const spotifyScopes = [
    "streaming",
    "user-read-email",
    "user-read-private",
    "user-modify-playback-state",
    "user-read-playback-state",
    "playlist-read-private",
    "playlist-read-collaborative"
].join(" ");

/* ------------------------------
      STATE
--------------------------------*/
let allTracks = [];
let remainingTracks = [];
let currentTrack = null;
let currentPlaylistName = "Aucune playlist chargÃ©e";
let showAnswer = false;

let accessToken = null;
let spotifyUser = null;
let spotifyPlaylists = [];

let spotifyPlayer = null;
let spotifyDeviceId = null;
let playerActivated = false;

/* ------------------------------
      UTILS
--------------------------------*/
function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    return Array.from(crypto.getRandomValues(new Uint8Array(length)))
                .map(x => chars[x % chars.length])
                .join("");
}

async function sha256(str) {
    return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
}

function base64encode(buffer) {
    return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
}

function saveToken(token, expiresIn) {
    accessToken = token;
    localStorage.setItem("spotify_access_token", token);
    localStorage.setItem("spotify_exp", Date.now() + expiresIn * 1000);
}

function loadToken() {
    const t = localStorage.getItem("spotify_access_token");
    const exp = localStorage.getItem("spotify_exp");
    if (!t || !exp || Date.now() > exp) return null;
    accessToken = t;
    return t;
}

/* ------------------------------
      UI UPDATE
--------------------------------*/
const trackArea = document.getElementById("track-area");
const playlistNameEl = document.getElementById("playlist-name");
const progressEl = document.getElementById("progress");
const btnShow = document.getElementById("show-answer");
const btnOK = document.getElementById("btn-ok");
const btnKO = document.getElementById("btn-ko");

function render() {
    playlistNameEl.textContent = currentPlaylistName;
    progressEl.textContent = `Restants : ${remainingTracks.length} / ${allTracks.length}`;

    if (allTracks.length === 0) {
        trackArea.innerHTML = `
            <div class="track-label">Aucune playlist chargÃ©e</div>
            <div class="track-artist">SÃ©lectionne une playlist en haut</div>
        `;
        btnShow.style.display = "none";
        btnOK.style.display = "none";
        btnKO.style.display = "none";
        return;
    }

    if (!currentTrack) return;

    if (!showAnswer) {
        btnShow.style.display = "inline-block";
        btnOK.style.display = "none";
        btnKO.style.display = "none";
        trackArea.innerHTML = `
            <div class="track-label">Ã‰coute la musiqueâ€¦</div>
            <div class="hidden-title">Titre cachÃ©</div>
            <div class="track-artist">Artiste cachÃ©</div>
        `;
    } else {
        btnShow.style.display = "none";
        btnOK.style.display = "inline-block";
        btnKO.style.display = "inline-block";
        trackArea.innerHTML = `
            <div class="track-label">RÃ©ponse :</div>
            <div class="track-title">${currentTrack.title}</div>
            <div class="track-artist">${currentTrack.artist}</div>
        `;
    }
}

/* ------------------------------
      BLIND TEST LOGIC
--------------------------------*/
function initGame(tracks, name) {
    allTracks = tracks || [];
    currentPlaylistName = name || "Playlist Spotify";
    remainingTracks = [...allTracks];
    showAnswer = false;
    pickRandomTrack();
}

function pickRandomTrack() {
    if (remainingTracks.length === 0) {
        currentTrack = null;
        trackArea.innerHTML = `<div class="emoji">ðŸŽ‰</div><div class="done-message">Tu connais toute la playlist !</div>`;
        return;
    }
    currentTrack = remainingTracks[Math.floor(Math.random()*remainingTracks.length)];
    showAnswer = false;
    playCurrentTrack();
    render();
}

/* ------------------------------
      SPOTIFY PLAYBACK
--------------------------------*/
async function playCurrentTrack() {
    if (!spotifyDeviceId || !currentTrack) return;

    try {
        // Make this device active
        await fetch("https://api.spotify.com/v1/me/player", {
            method: "PUT",
            headers: { Authorization: "Bearer "+accessToken, "Content-Type": "application/json" },
            body: JSON.stringify({ device_ids: [spotifyDeviceId], play: false })
        });

        // Play the track
        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
            method: "PUT",
            headers: { Authorization: "Bearer "+accessToken, "Content-Type":"application/json" },
            body: JSON.stringify({ uris: [currentTrack.uri] })
        });

    } catch (e) { console.error("Erreur playback:", e); }
}

/* ------------------------------
      SPOTIFY AUTH
--------------------------------*/
async function loginSpotify() {
    const verifier = generateRandomString(64);
    const challenge = base64encode(await sha256(verifier));
    localStorage.setItem("spotify_verifier", verifier);

    const params = new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        redirect_uri: redirectUri,
        code_challenge_method: "S256",
        code_challenge: challenge,
        scope: spotifyScopes
    });

    window.location = "https://accounts.spotify.com/authorize?" + params.toString();
}

async function exchangeToken(code) {
    const verifier = localStorage.getItem("spotify_verifier");
    const body = new URLSearchParams({
        client_id: clientId,
        grant_type: "authorization_code",
        code,
        redirect_uri: redirectUri,
        code_verifier: verifier
    });

    const resp = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded" },
        body
    });

    const data = await resp.json();
    saveToken(data.access_token, data.expires_in);
}

/* ------------------------------
      LOAD PLAYLISTS
--------------------------------*/
async function loadPlaylists() {
    const out = [];
    let url = "https://api.spotify.com/v1/me/playlists?limit=50";

    while (url) {
        const r = await fetch(url, { headers: {Authorization:"Bearer "+accessToken}});
        const j = await r.json();
        out.push(...j.items);
        url = j.next;
    }
    return out;
}

async function loadTracks(playlistId, playlistName) {
    let items = [];
    let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;

    while (url) {
        const r = await fetch(url, { headers:{Authorization:"Bearer "+accessToken}});
        const j = await r.json();
        items.push(...j.items);
        url = j.next;
    }

    const tracks = items
        .map(x => x.track)
        .filter(x => x && x.id && x.artists?.length)
        .map(x => ({
            id: x.id,
            uri: x.uri,
            title: x.name,
            artist: x.artists[0].name
        }));

    initGame(tracks, playlistName);
    render();
}

/* ------------------------------
      WEB PLAYBACK SDK
--------------------------------*/
function initPlayer() {
    if (!window.Spotify || spotifyPlayer) return;

    spotifyPlayer = new Spotify.Player({
        name: "BlindTrainer Player",
        getOAuthToken: cb => cb(accessToken),
        volume: 0.5
    });

    spotifyPlayer.addListener("ready", ({device_id}) => {
        spotifyDeviceId = device_id;
        renderSpotifyArea();
    });

    spotifyPlayer.addListener("initialization_error", e => console.error(e));
    spotifyPlayer.addListener("authentication_error", e => console.error(e));
    spotifyPlayer.addListener("account_error", e => console.error(e));
    spotifyPlayer.addListener("playback_error", e => console.error(e));

    spotifyPlayer.connect();
}

window.onSpotifyWebPlaybackSDKReady = () => {
    if (accessToken) initPlayer();
};

/* ------------------------------
      UI SPOTIFY SECTION
--------------------------------*/
function renderSpotifyArea() {
    const status = document.getElementById("spotify-status");
    const actions = document.getElementById("spotify-actions");
    actions.innerHTML = "";

    if (!accessToken) {
        status.textContent = "Non connectÃ© Ã  Spotify";
        const b = document.createElement("button");
        b.textContent = "Connexion Spotify";
        b.className = "btn-primary btn-small";
        b.onclick = loginSpotify;
        actions.appendChild(b);
        return;
    }

    const userName = spotifyUser?.display_name || "Utilisateur Spotify";
    status.textContent =
        spotifyDeviceId ?
        `ConnectÃ© en tant que ${userName} â€¢ Player prÃªt` :
        `ConnectÃ© en tant que ${userName} â€¢ Initialisationâ€¦`;

    const select = document.createElement("select");
    spotifyPlaylists.forEach(p => {
        const o = document.createElement("option");
        o.value = p.id;
        o.textContent = `${p.name} (${p.tracks.total})`;
        select.appendChild(o);
    });

    const btn = document.createElement("button");
    btn.textContent = "Charger la playlist";
    btn.className = "btn-secondary btn-small";
    btn.onclick = () => loadTracks(select.value, select.options[select.selectedIndex].text);

    actions.appendChild(select);
    actions.appendChild(btn);
}

/* ------------------------------
      BOOTSTRAP
--------------------------------*/
(async function start() {
    loadToken();

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    if (!accessToken && code) {
        await exchangeToken(code);
        window.history.replaceState({}, document.title, redirectUri);
    }

    loadToken();

    if (accessToken) {
        const r1 = await fetch("https://api.spotify.com/v1/me", {
            headers:{Authorization:"Bearer "+accessToken}
        });
        spotifyUser = await r1.json();

        spotifyPlaylists = await loadPlaylists();
        initPlayer();
    }

    renderSpotifyArea();
    render();
})();

/* ------------------------------
      EVENT HANDLERS
--------------------------------*/
btnShow.onclick = () => {
    showAnswer = true;
    render();
};

btnOK.onclick = () => {
    remainingTracks = remainingTracks.filter(t => t.id !== currentTrack.id);
    pickRandomTrack();
};

btnKO.onclick = () => pickRandomTrack();

document.getElementById("btn-reset").onclick = () => {
    initGame(allTracks, currentPlaylistName);
    render();
};

</script>
</body>
</html>
