<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Blind Test ‚Äì Entra√Ænement</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Ic√¥ne (ajoute un fichier icon-192.png dans le repo si tu veux un vrai visuel) -->
    <link rel="icon" href="icon-192.png" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <meta name="theme-color" content="#111827" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #111827;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: stretch;
            min-height: 100vh;
        }
        .app {
            width: 100%;
            max-width: 480px;
            padding: 20px 14px 32px;
            box-sizing: border-box;
        }
        h1 {
            font-size: 1.4rem;
            margin: 0 0 10px;
            text-align: center;
        }
        .subtitle {
            text-align: center;
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 14px;
        }
        .card {
            background: #1f2937;
            border-radius: 14px;
            padding: 12px 14px;
            margin-bottom: 14px;
        }
        .card-spotify {
            margin-bottom: 16px;
        }
        .spotify-status {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .spotify-actions {
            display: flex;
            justify-content: center;
        }
        .spotify-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .spotify-row select {
            flex: 1;
            background: #111827;
            color: #e5e7eb;
            border-radius: 999px;
            border: 1px solid #374151;
            padding: 8px 10px;
            font-size: 0.85rem;
            max-width: 100%;
        }

        button {
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary {
            background: #3b82f6;
            color: #ffffff;
        }
        .btn-secondary {
            background: #374151;
            color: #e5e7eb;
        }
        .btn-ok {
            background: #22c55e;
            color: #022c22;
        }
        .btn-ko {
            background: #f97316;
            color: #111827;
        }
        .btn-small {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .track-label {
            text-align: center;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }
        .hidden-title {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .track-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .track-artist {
            text-align: center;
            color: #9ca3af;
            font-size: 0.95rem;
        }
        .progress {
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .buttons-main {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 18px;
        }
        .buttons-main button {
            width: 100%;
            font-size: 1.1rem;
            padding: 14px 18px;
        }
        .buttons-bottom {
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }
        .buttons-bottom button {
            padding: 8px 14px;
            font-size: 0.85rem;
        }

        .done-message {
            font-size: 1.1rem;
            margin-top: 6px;
            text-align: center;
        }
        .emoji {
            font-size: 1.8rem;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="app">
    <h1>Blind Test ‚Äì Entra√Ænement</h1>
    <div class="subtitle">
        Choisis une playlist Spotify et devine les titres (id√©al en voiture) üöó
    </div>

    <!-- Panel playlist -->
    <div class="card card-spotify">
        <div id="spotify-status" class="spotify-status"></div>
        <div id="spotify-actions" class="spotify-actions"></div>
    </div>

    <!-- Panel blind test -->
    <div class="card">
        <div id="progress" class="progress"></div>
        <div id="track-area"></div>

        <div class="buttons-main">
            <button id="show-answer" class="btn-primary">Afficher la r√©ponse</button>
            <button id="btn-ok" class="btn-ok">OK (je connaissais)</button>
            <button id="btn-ko" class="btn-ko">KO (je ne connaissais pas)</button>
            <button id="btn-play-toggle" class="btn-secondary">‚è∏ Pause</button>
        </div>
    </div>

    <div class="buttons-bottom">
        <button id="btn-reset" class="btn-secondary">R√©initialiser la playlist</button>
    </div>
</div>

<!-- SDK Spotify -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
/* ------------------------------
   CONFIG SPOTIFY
--------------------------------*/
const clientId = "f2f3de9d08c74a71a97d8250b1864204";
const redirectUri = "https://bilbofthefirst.github.io/BlindTrainer/";

const spotifyScopes = [
    "streaming",
    "user-read-email",
    "user-read-private",
    "user-modify-playback-state",
    "user-read-playback-state",
    "playlist-read-private",
    "playlist-read-collaborative"
].join(" ");

/* ------------------------------
   STATE
--------------------------------*/
let allTracks = [];
let remainingTracks = [];
let currentTrack = null;
let currentPlaylistName = "Aucune playlist charg√©e";
let showAnswer = false;

let accessToken = null;
let spotifyUser = null;
let spotifyPlaylists = [];

let spotifyPlayer = null;
let spotifyDeviceId = null;
let isPlaying = false;

/* ------------------------------
   UTILS
--------------------------------*/
function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    return Array.from(crypto.getRandomValues(new Uint8Array(length)))
                .map(x => chars[x % chars.length])
                .join("");
}

async function sha256(str) {
    return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
}

function base64encode(buffer) {
    return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
}

function saveToken(token, expiresIn) {
    accessToken = token;
    localStorage.setItem("spotify_access_token", token);
    localStorage.setItem("spotify_exp", Date.now() + expiresIn * 1000);
}

function loadToken() {
    const t = localStorage.getItem("spotify_access_token");
    const exp = localStorage.getItem("spotify_exp");
    if (!t || !exp || Date.now() > exp) return null;
    accessToken = t;
    return t;
}

/* ------------------------------
   UI ELEMENTS
--------------------------------*/
const trackArea = document.getElementById("track-area");
const progressEl = document.getElementById("progress");
const btnShow = document.getElementById("show-answer");
const btnOK = document.getElementById("btn-ok");
const btnKO = document.getElementById("btn-ko");
const btnPlayToggle = document.getElementById("btn-play-toggle");
const btnReset = document.getElementById("btn-reset");

/* ------------------------------
   RENDER
--------------------------------*/
function updatePlayButton() {
    if (!allTracks.length) {
        btnPlayToggle.style.display = "none";
        return;
    }
    btnPlayToggle.style.display = "block";
    btnPlayToggle.textContent = isPlaying ? "‚è∏ Pause" : "‚ñ∂Ô∏è Reprendre";
}

function render() {
    progressEl.textContent = `Restants : ${remainingTracks.length} / ${allTracks.length}`;
    updatePlayButton();

    if (allTracks.length === 0) {
        trackArea.innerHTML = `
            <div class="track-label">Aucune playlist charg√©e</div>
            <div class="track-artist">S√©lectionne une playlist en haut pour commencer.</div>
        `;
        btnShow.style.display = "none";
        btnOK.style.display = "none";
        btnKO.style.display = "none";
        return;
    }

    if (!currentTrack) return;

    if (!showAnswer) {
        btnShow.style.display = "block";
        btnOK.style.display = "none";
        btnKO.style.display = "none";
        trackArea.innerHTML = `
            <div class="track-label">√âcoute la musique‚Ä¶</div>
            <div class="hidden-title">Titre cach√©</div>
            <div class="track-artist">Artiste cach√©</div>
        `;
    } else {
        btnShow.style.display = "none";
        btnOK.style.display = "block";
        btnKO.style.display = "block";
        trackArea.innerHTML = `
            <div class="track-label">R√©ponse :</div>
            <div class="track-title">${currentTrack.title}</div>
            <div class="track-artist">${currentTrack.artist}</div>
        `;
    }
}

/* ------------------------------
   BLIND TEST LOGIC
--------------------------------*/
function initGame(tracks, name) {
    allTracks = tracks || [];
    currentPlaylistName = name || "Playlist Spotify";
    remainingTracks = [...allTracks];
    showAnswer = false;
    isPlaying = false;
    pickRandomTrack();
}

function pickRandomTrack() {
    if (remainingTracks.length === 0) {
        isPlaying = false;
        updatePlayButton();
        trackArea.innerHTML = `
            <div class="emoji">üéâ</div>
            <div class="done-message">Tu connais toute la playlist !</div>
        `;
        btnShow.style.display = "none";
        btnOK.style.display = "none";
        btnKO.style.display = "none";
        progressEl.textContent = `Restants : 0 / ${allTracks.length}`;
        return;
    }
    currentTrack = remainingTracks[Math.floor(Math.random() * remainingTracks.length)];
    showAnswer = false;
    playCurrentTrack();
    render();
}

/* ------------------------------
   SPOTIFY PLAYBACK
--------------------------------*/
async function playCurrentTrack() {
    if (!spotifyDeviceId || !currentTrack) return;

    try {
        // Rendre ce device actif
        await fetch("https://api.spotify.com/v1/me/player", {
            method: "PUT",
            headers: {
                Authorization: "Bearer " + accessToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ device_ids: [spotifyDeviceId], play: false })
        });

        // Jouer ce morceau
        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
            method: "PUT",
            headers: {
                Authorization: "Bearer " + accessToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ uris: [currentTrack.uri] })
        });

        isPlaying = true;
        updatePlayButton();
    } catch (e) {
        console.error("Erreur playback:", e);
    }
}

async function togglePlayPause() {
    if (!spotifyDeviceId || !accessToken || !allTracks.length) return;

    try {
        if (isPlaying) {
            await fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${spotifyDeviceId}`, {
                method: "PUT",
                headers: { Authorization: "Bearer " + accessToken }
            });
            isPlaying = false;
        } else {
            await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
                method: "PUT",
                headers: { Authorization: "Bearer " + accessToken }
            });
            isPlaying = true;
        }
        updatePlayButton();
    } catch (e) {
        console.error("Erreur play/pause:", e);
    }
}

/* ------------------------------
   SPOTIFY AUTH
--------------------------------*/
async function loginSpotify() {
    const verifier = generateRandomString(64);
    const challenge = base64encode(await sha256(verifier));
    localStorage.setItem("spotify_verifier", verifier);

    const params = new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        redirect_uri: redirectUri,
        code_challenge_method: "S256",
        code_challenge: challenge,
        scope: spotifyScopes
    });

    window.location.href =
        "https://accounts.spotify.com/authorize?" + params.toString();
}

async function exchangeToken(code) {
    const verifier = localStorage.getItem("spotify_verifier");
    const body = new URLSearchParams({
        client_id: clientId,
        grant_type: "authorization_code",
        code,
        redirect_uri: redirectUri,
        code_verifier: verifier
    });

    const resp = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
    });

    const data = await resp.json();
    if (data.access_token) {
        saveToken(data.access_token, data.expires_in);
    } else {
        console.error("Erreur token", data);
    }
}

/* ------------------------------
   CHARGEMENT PLAYLISTS / TRACKS
--------------------------------*/
async function loadPlaylists() {
    const out = [];
    let url = "https://api.spotify.com/v1/me/playlists?limit=50";

    while (url) {
        const r = await fetch(url, {
            headers: { Authorization: "Bearer " + accessToken }
        });
        const j = await r.json();
        out.push(...(j.items || []));
        url = j.next;
    }
    return out;
}

async function loadTracks(playlistId, playlistName) {
    let items = [];
    let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;

    while (url) {
        const r = await fetch(url, {
            headers: { Authorization: "Bearer " + accessToken }
        });
        const j = await r.json();
        items.push(...(j.items || []));
        url = j.next;
    }

    const tracks = items
        .map(x => x.track)
        .filter(x => x && x.id && x.artists && x.artists.length)
        .map(x => ({
            id: x.id,
            uri: x.uri,
            title: x.name,
            artist: x.artists[0].name
        }));

    initGame(tracks, playlistName);
    render();
}

/* ------------------------------
   WEB PLAYBACK SDK
--------------------------------*/
function initPlayer() {
    if (!window.Spotify || spotifyPlayer) return;

    spotifyPlayer = new Spotify.Player({
        name: "BlindTrainer Player",
        getOAuthToken: cb => cb(accessToken),
        volume: 0.5
    });

    spotifyPlayer.addListener("ready", ({ device_id }) => {
        spotifyDeviceId = device_id;
        renderSpotifyArea();
    });

    spotifyPlayer.addListener("initialization_error", e => console.error(e));
    spotifyPlayer.addListener("authentication_error", e => console.error(e));
    spotifyPlayer.addListener("account_error", e => console.error(e));
    spotifyPlayer.addListener("playback_error", e => console.error(e));

    spotifyPlayer.connect();
}

window.onSpotifyWebPlaybackSDKReady = () => {
    if (accessToken) initPlayer();
};

/* ------------------------------
   UI SPOTIFY PANEL
--------------------------------*/
function renderSpotifyArea() {
    const status = document.getElementById("spotify-status");
    const actions = document.getElementById("spotify-actions");
    actions.innerHTML = "";

    if (!accessToken) {
        status.textContent = "Non connect√© √† Spotify";
        const b = document.createElement("button");
        b.textContent = "Connexion Spotify";
        b.className = "btn-primary btn-small";
        b.onclick = loginSpotify;
        actions.appendChild(b);
        return;
    }

    const userName = spotifyUser?.display_name || "Utilisateur Spotify";
    status.textContent =
        spotifyDeviceId
            ? `Connect√© en tant que ${userName} ‚Ä¢ Player pr√™t`
            : `Connect√© en tant que ${userName} ‚Ä¢ Initialisation du player‚Ä¶`;

    if (!spotifyPlaylists || spotifyPlaylists.length === 0) {
        actions.textContent = "Chargement des playlists‚Ä¶";
        return;
    }

    const row = document.createElement("div");
    row.className = "spotify-row";

    const select = document.createElement("select");
    spotifyPlaylists.forEach(p => {
        const o = document.createElement("option");
        o.value = p.id;
        o.textContent = `${p.name} (${p.tracks.total})`;
        select.appendChild(o);
    });

    const btn = document.createElement("button");
    btn.className = "btn-secondary btn-small btn-icon";
    btn.textContent = "‚ü≥"; // ic√¥ne "recharger/charger"
    btn.onclick = () => {
        const opt = select.options[select.selectedIndex];
        loadTracks(opt.value, opt.text);
    };

    row.appendChild(select);
    row.appendChild(btn);
    actions.appendChild(row);
}

/* ------------------------------
   BOOTSTRAP
--------------------------------*/
(async function start() {
    loadToken();

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    if (!accessToken && code) {
        await exchangeToken(code);
        window.history.replaceState({}, document.title, redirectUri);
    }

    loadToken();

    if (accessToken) {
        const r1 = await fetch("https://api.spotify.com/v1/me", {
            headers: { Authorization: "Bearer " + accessToken }
        });
        spotifyUser = await r1.json();

        spotifyPlaylists = await loadPlaylists();
        initPlayer();
    }

    renderSpotifyArea();
    render();
})();

/* ------------------------------
   EVENTS
--------------------------------*/
btnShow.onclick = () => {
    showAnswer = true;
    render();
};
btnOK.onclick = () => {
    if (!currentTrack) return;
    remainingTracks = remainingTracks.filter(t => t.id !== currentTrack.id);
    pickRandomTrack();
};
btnKO.onclick = () => {
    if (!currentTrack) return;
    pickRandomTrack();
};
btnPlayToggle.onclick = togglePlayPause;
btnReset.onclick = () => {
    initGame(allTracks, currentPlaylistName);
    render();
};
</script>
</body>
</html>
