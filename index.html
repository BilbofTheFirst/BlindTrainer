<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Blind Test ‚Äì Entra√Ænement</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #111827;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .app {
            width: 100%;
            max-width: 480px;
            padding: 24px 16px 40px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 1.3rem;
            margin: 0 0 8px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 16px;
        }

        .card {
            background: #1f2937;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .card-spotify {
            margin-bottom: 20px;
        }

        .spotify-status {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .spotify-actions button,
        .spotify-actions select,
        .spotify-actions label {
            font-size: 0.85rem;
        }

        .spotify-actions select {
            background: #111827;
            color: #e5e7eb;
            border-radius: 999px;
            border: 1px solid #374151;
            padding: 6px 8px;
            margin-right: 6px;
            margin-top: 4px;
            max-width: 100%;
        }

        .playlist-name {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .progress {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .track-label {
            font-size: 1rem;
            margin-bottom: 12px;
            text-align: center;
        }

        .track-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 4px;
            text-align: center;
        }

        .track-artist {
            font-size: 1rem;
            color: #9ca3af;
            text-align: center;
        }

        .hidden-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
            text-align: center;
        }

        .buttons-main,
        .buttons-bottom {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 10px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .btn-ok {
            background: #22c55e;
            color: #022c22;
        }

        .btn-ko {
            background: #f97316;
            color: #111827;
        }

        .btn-secondary {
            background: #374151;
            color: #e5e7eb;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .done-message {
            font-size: 1.1rem;
            margin: 8px 0;
            text-align: center;
        }

        .emoji {
            font-size: 1.6rem;
            text-align: center;
        }

        .audio-hint {
            font-size: 0.8rem;
            color: #9ca3af;
            text-align: center;
            margin-top: 4px;
        }
    </style>
</head>
<body>
<div class="app">
    <h1>Blind Test ‚Äì Entra√Ænement</h1>
    <div class="subtitle">
        Connecte-toi √† Spotify, choisis une playlist, et entra√Æne-toi üéß
    </div>

    <!-- Carte Spotify (login + s√©lection playlist) -->
    <div class="card card-spotify">
        <div id="spotify-status" class="spotify-status"></div>
        <div id="spotify-actions" class="spotify-actions"></div>
    </div>

    <!-- Carte du blind test -->
    <div class="card">
        <div id="playlist-name" class="playlist-name"></div>
        <div id="progress" class="progress"></div>

        <div id="track-area">
            <!-- contenu dynamique -->
        </div>

        <div class="audio-hint">
            Un extrait de 30s est jou√© automatiquement (si disponible).
        </div>

        <div class="buttons-main">
            <button id="show-answer" class="btn-primary">Afficher la r√©ponse</button>
        </div>
    </div>

    <div class="buttons-bottom">
        <button id="btn-ok" class="btn-ok">OK (je connaissais)</button>
        <button id="btn-ko" class="btn-ko">KO (je ne connaissais pas)</button>
        <button id="btn-reset" class="btn-secondary">R√©initialiser</button>
    </div>
</div>

<!-- Lecteur audio cach√© pour les previews Spotify -->
<audio id="audio-player" style="display:none;"></audio>

<script>
    /********************
     * CONFIG SPOTIFY   *
     ********************/
    const clientId = 'f2f3de9d08c74a71a97d8250b1864204'; 
    const redirectUri = 'https://bilbofthefirst.github.io/BlindTrainer/'; 
    const spotifyScopes = 'playlist-read-private playlist-read-collaborative';

    /********************
     * STATE GLOBAL     *
     ********************/
    // Structure Track: { id, title, artist, previewUrl? }

    const FAKE_TRACKS = [
        { id: "1", title: "Billie Jean", artist: "Michael Jackson", previewUrl: null },
        { id: "2", title: "Smells Like Teen Spirit", artist: "Nirvana", previewUrl: null },
        { id: "3", title: "Shape of You", artist: "Ed Sheeran", previewUrl: null },
        { id: "4", title: "Rolling in the Deep", artist: "Adele", previewUrl: null },
        { id: "5", title: "Wonderwall", artist: "Oasis", previewUrl: null }
    ];

    let allTracks = FAKE_TRACKS.slice();
    let remainingTracks = [];
    let currentTrack = null;
    let showAnswer = false;
    let currentPlaylistName = 'Playlist locale fictive';

    let accessToken = null;
    let spotifyUser = null;
    let spotifyPlaylists = [];

    const progressEl = document.getElementById("progress");
    const trackAreaEl = document.getElementById("track-area");
    const showAnswerBtn = document.getElementById("show-answer");
    const okBtn = document.getElementById("btn-ok");
    const koBtn = document.getElementById("btn-ko");
    const resetBtn = document.getElementById("btn-reset");
    const playlistNameEl = document.getElementById("playlist-name");
    const audioPlayer = document.getElementById("audio-player");

    /********************
     * UTILS            *
     ********************/
    function escapeHtml(str) {
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    const generateRandomString = (length) => {
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const values = crypto.getRandomValues(new Uint8Array(length));
        return values.reduce((acc, x) => acc + possible[x % possible.length], "");
    };

    const sha256 = async (plain) => {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        return window.crypto.subtle.digest('SHA-256', data);
    };

    const base64encode = (input) => {
        return btoa(String.fromCharCode(...new Uint8Array(input)))
            .replace(/=/g, '')
            .replace(/\+/g, '-')
            .replace(/\//g, '_');
    };

    function saveTokenToStorage(token, expiresIn) {
        accessToken = token;
        const expiresAt = Date.now() + expiresIn * 1000;
        localStorage.setItem('spotify_access_token', token);
        localStorage.setItem('spotify_expires_at', String(expiresAt));
    }

    function loadTokenFromStorage() {
        const token = localStorage.getItem('spotify_access_token');
        const expiresAt = localStorage.getItem('spotify_expires_at');
        if (!token || !expiresAt) return null;
        if (Date.now() > parseInt(expiresAt, 10)) {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_expires_at');
            return null;
        }
        accessToken = token;
        return token;
    }

    function cleanUrlParams() {
        if (window.history.replaceState) {
            const url = new URL(window.location.href);
            url.search = '';
            window.history.replaceState({}, document.title, url.toString());
        }
    }

    /********************
     * BLIND TEST LOGIC *
     ********************/
    function initGame(tracks, playlistLabel) {
        if (!tracks || tracks.length === 0) {
            allTracks = FAKE_TRACKS.slice();
            currentPlaylistName = 'Playlist locale fictive';
        } else {
            allTracks = tracks;
            currentPlaylistName = playlistLabel || 'Playlist Spotify';
        }
        remainingTracks = allTracks.slice();
        currentTrack = null;
        showAnswer = false;
        stopAudio();
        pickRandomTrack();
        render();
    }

    function pickRandomTrack() {
        if (remainingTracks.length === 0) {
            currentTrack = null;
            showAnswer = false;
            stopAudio();
            render();
            return;
        }
        const index = Math.floor(Math.random() * remainingTracks.length);
        currentTrack = remainingTracks[index];
        showAnswer = false;
        playPreviewForCurrentTrack();
        render();
    }

    function playPreviewForCurrentTrack() {
        stopAudio();
        if (currentTrack && currentTrack.previewUrl) {
            audioPlayer.src = currentTrack.previewUrl;
            audioPlayer.play().catch(() => {
                // silencieux si autoplay bloqu√©
            });
        }
    }

    function stopAudio() {
        if (!audioPlayer) return;
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
    }

    function render() {
        playlistNameEl.textContent = currentPlaylistName;
        progressEl.textContent = `Restants : ${remainingTracks.length} / ${allTracks.length}`;

        if (remainingTracks.length === 0) {
            trackAreaEl.innerHTML = `
                <div class="emoji">üéâ</div>
                <div class="done-message">Tu connais toute la playlist !</div>
            `;
            showAnswerBtn.disabled = true;
            okBtn.disabled = true;
            koBtn.disabled = true;
            return;
        }

        showAnswerBtn.disabled = showAnswer;
        okBtn.disabled = false;
        koBtn.disabled = false;

        if (!showAnswer || !currentTrack) {
            trackAreaEl.innerHTML = `
                <div class="track-label">√âcoute la musique‚Ä¶</div>
                <div class="hidden-title">Titre cach√©</div>
                <div class="track-artist">Artiste cach√©</div>
            `;
        } else {
            trackAreaEl.innerHTML = `
                <div class="track-label">R√©ponse :</div>
                <div class="track-title">${currentTrack.title}</div>
                <div class="track-artist">par ${currentTrack.artist}</div>
            `;
        }
    }

    /********************
     * UI BUTTON EVENTS *
     ********************/
    showAnswerBtn.addEventListener("click", () => {
        if (!showAnswer && remainingTracks.length > 0) {
            showAnswer = true;
            render();
        }
    });

    okBtn.addEventListener("click", () => {
        if (!currentTrack) return;
        remainingTracks = remainingTracks.filter(t => t.id !== currentTrack.id);
        pickRandomTrack();
    });

    koBtn.addEventListener("click", () => {
        if (!currentTrack) return;
        pickRandomTrack();
    });

    resetBtn.addEventListener("click", () => {
        initGame(allTracks, currentPlaylistName);
    });

    /********************
     * SPOTIFY AUTH     *
     ********************/
    async function startSpotifyLogin() {
        const codeVerifier = generateRandomString(64);
        const hashed = await sha256(codeVerifier);
        const codeChallenge = base64encode(hashed);

        localStorage.setItem('spotify_code_verifier', codeVerifier);

        const authUrl = new URL("https://accounts.spotify.com/authorize");
        const params = {
            response_type: 'code',
            client_id: clientId,
            scope: spotifyScopes,
            code_challenge_method: 'S256',
            code_challenge: codeChallenge,
            redirect_uri: redirectUri
        };
        authUrl.search = new URLSearchParams(params).toString();
        window.location.href = authUrl.toString();
    }

    async function exchangeToken(code) {
        const codeVerifier = localStorage.getItem('spotify_code_verifier');
        if (!codeVerifier) {
            console.error('Code verifier manquant');
            return;
        }

        const payload = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                client_id: clientId,
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: redirectUri,
                code_verifier: codeVerifier
            })
        };

        const url = "https://accounts.spotify.com/api/token";
        const body = await fetch(url, payload);
        if (!body.ok) {
            console.error('Erreur token', body.status);
            return;
        }
        const response = await body.json();
        saveTokenToStorage(response.access_token, response.expires_in);
    }

    async function fetchSpotifyUserAndPlaylists() {
        if (!accessToken) return;

        try {
            // Profil utilisateur
            const meResp = await fetch('https://api.spotify.com/v1/me', {
                headers: { Authorization: 'Bearer ' + accessToken }
            });
            if (meResp.ok) {
                spotifyUser = await meResp.json();
            }

            // Playlists (premi√®re page)
            const plResp = await fetch('https://api.spotify.com/v1/me/playlists?limit=20', {
                headers: { Authorization: 'Bearer ' + accessToken }
            });
            if (plResp.ok) {
                const data = await plResp.json();
                spotifyPlaylists = data.items || [];
            } else {
                console.error('Erreur playlists', plResp.status);
            }
        } catch (e) {
            console.error('Erreur fetch Spotify', e);
        }

        renderSpotifyArea();
    }

    async function loadPlaylistTracks(playlistId, playlistName) {
        if (!accessToken) return;
        try {
            const url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
            const resp = await fetch(url, {
                headers: { Authorization: 'Bearer ' + accessToken }
            });
            if (!resp.ok) {
                console.error('Erreur tracks', resp.status);
                alert("Erreur lors du chargement des morceaux.");
                return;
            }
            const data = await resp.json();
            const tracks = (data.items || [])
                .map(item => item.track)
                .filter(track => track && track.preview_url) // on garde seulement ceux avec un extrait
                .map(track => ({
                    id: track.id,
                    title: track.name,
                    artist: (track.artists && track.artists[0]) ? track.artists[0].name : '',
                    previewUrl: track.preview_url
                }));

            if (!tracks.length) {
                alert("Cette playlist n'a pas d'extraits audio (preview) utilisables. Essaie une autre playlist.");
                return;
            }

            initGame(tracks, `Playlist : ${playlistName}`);
        } catch (e) {
            console.error('Erreur playlist tracks', e);
            alert("Erreur lors du chargement de la playlist Spotify.");
        }
    }

    function renderSpotifyArea() {
        const statusEl = document.getElementById('spotify-status');
        const actionsEl = document.getElementById('spotify-actions');
        actionsEl.innerHTML = '';

        if (!accessToken) {
            statusEl.textContent = "Non connect√© √† Spotify";
            const btn = document.createElement('button');
            btn.textContent = "Se connecter √† Spotify";
            btn.className = 'btn-primary btn-small';
            btn.addEventListener('click', startSpotifyLogin);
            actionsEl.appendChild(btn);
            return;
        }

        const userName = spotifyUser
            ? (spotifyUser.display_name || spotifyUser.id)
            : 'Utilisateur Spotify';

        statusEl.textContent = `Connect√© √† Spotify en tant que ${userName}`;

        if (!spotifyPlaylists || spotifyPlaylists.length === 0) {
            actionsEl.textContent = "Aucune playlist trouv√©e (ou chargement en cours).";
            return;
        }

        const label = document.createElement('label');
        label.textContent = "Playlist : ";
        label.setAttribute('for', 'spotify-playlist-select');

        const select = document.createElement('select');
        select.id = 'spotify-playlist-select';

        spotifyPlaylists.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.name} (${p.tracks.total})`;
            select.appendChild(opt);
        });

        const btnLoad = document.createElement('button');
        btnLoad.textContent = "Charger la playlist";
        btnLoad.className = 'btn-secondary btn-small';
        btnLoad.addEventListener('click', async () => {
            const playlistId = select.value;
            const playlistName = spotifyPlaylists.find(p => p.id === playlistId)?.name || '';
            await loadPlaylistTracks(playlistId, playlistName);
        });

        actionsEl.appendChild(label);
        actionsEl.appendChild(select);
        actionsEl.appendChild(btnLoad);
    }

    /********************
     * BOOTSTRAP        *
     ********************/
    (async function bootstrap() {
        // 1) Regarder si on a d√©j√† un token valable
        loadTokenFromStorage();

        // 2) Regarder si on revient de Spotify avec ?code=...
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        if (!accessToken && code) {
            await exchangeToken(code);
            cleanUrlParams();
        }

        // Recharger le token (au cas o√π on vient de l‚Äôobtenir)
        loadTokenFromStorage();

        // 3) Si token, on va chercher user + playlists
        if (accessToken) {
            await fetchSpotifyUserAndPlaylists();
        } else {
            renderSpotifyArea();
        }

        // 4) Initialiser le jeu avec les fake tracks (en attendant qu‚Äôune playlist soit choisie)
        initGame(allTracks, currentPlaylistName);
    })();
</script>
</body>
</html>
